<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sentence Drill — Player</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <main class="wrap">
    <header class="header">
      <h1 class="title">Sentence Drill</h1>
      <p class="muted">Pick a voice and options, then start.</p>
    </header>

    <!-- OPTIONS -->
    <section id="options" class="card">
      <div class="field">
        <div class="row between">
          <label for="voiceSelect" class="label">Voice</label>
          <button id="refreshVoices" class="btn xs">Refresh voices</button>
        </div>
        <select id="voiceSelect" class="input"></select>
        <p class="muted" id="voiceHint">Voices are pulled from your browser/OS (Edge, Chrome, macOS, Windows, etc.).</p>
      </div>

      <div class="field">
        <label for="rate" class="label">Rate <span id="rateValue" class="mono badge">1.00</span></label>
        <input id="rate" class="range" type="range" min="0.50" max="1.50" step="0.01" value="1.00"/>
        <p class="muted">0.50 (50% slower) ← normal 1.00 → 1.50 (50% faster)</p>
      </div>

      <div class="row gap">
        <div class="field grow">
          <label for="setSize" class="label">Sentences per set</label>
          <select id="setSize" class="input">
            <option value="3">3</option>
            <option value="5" selected>5</option>
            <option value="8">8</option>
            <option value="10">10</option>
            <option value="15">15</option>
            <option value="20">20</option>
          </select>
        </div>

        <div class="field grow">
          <label for="startPoint" class="label">Start point (first sentence of each set)</label>
          <select id="startPoint" class="input"></select>
        </div>

        <div class="field grow">
          <label for="repetitions" class="label">Repetitions per sentence</label>
          <select id="repetitions" class="input">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3" selected>3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>
      </div>

      <div class="field row gap">
        <label class="toggle">
          <input type="checkbox" id="randomize">
          <span>Randomize (within session)</span>
        </label>
        <label class="toggle">
          <input type="checkbox" id="autoAdvance" checked>
          <span>Auto-Advance (don’t stop after each set)</span>
        </label>
      </div>

      <div class="row gap">
        <button id="studyBtn" class="btn primary">Study</button>
        <button id="backBtn" class="btn">Back to Import</button>
      </div>
    </section>

    <!-- STUDY CONTROLS -->
    <section id="studyControls" class="card" style="display:none;">
      <div class="row gap">
        <button id="pauseBtn" class="btn">Pause</button>
        <button id="stopBtn" class="btn danger">Stop</button>
      </div>
      <p class="muted mono" id="progress">Ready…</p>
    </section>

    <!-- CURRENT SENTENCE -->
    <section id="nowPlaying" class="card big" style="display:none;">
      <div class="now">
        <div id="nowChinese" class="now-cn"></div>
        <div id="nowEnglish" class="now-en"></div>
      </div>
    </section>
  </main>

  <script>
    (function () {
      const dataRaw = sessionStorage.getItem('sentences');
      let SENTENCES = [];
      try { SENTENCES = JSON.parse(dataRaw || '[]') || []; } catch {}
      if (!SENTENCES.length) {
        alert('No sentences loaded. Please import a CSV.');
        window.location.href = 'index.html';
        return;
      }

      // elements
      const options = document.getElementById('options');
      const studyControls = document.getElementById('studyControls');
      const progress = document.getElementById('progress');
      const voiceSelect = document.getElementById('voiceSelect');
      const refreshVoicesBtn = document.getElementById('refreshVoices');
      const rateEl = document.getElementById('rate');
      const rateValue = document.getElementById('rateValue');
      const setSizeEl = document.getElementById('setSize');
      const startPointEl = document.getElementById('startPoint');
      const repetitionsEl = document.getElementById('repetitions');
      const randomizeEl = document.getElementById('randomize');
      const autoAdvanceEl = document.getElementById('autoAdvance');
      const studyBtn = document.getElementById('studyBtn');
      const backBtn = document.getElementById('backBtn');
      const pauseBtn = document.getElementById('pauseBtn');
      const stopBtn = document.getElementById('stopBtn');
      const nowPlaying = document.getElementById('nowPlaying');
      const nowChinese = document.getElementById('nowChinese');
      const nowEnglish = document.getElementById('nowEnglish');

      const synth = window.speechSynthesis;
      let voices = [];
      function populateVoices() {
        voices = synth.getVoices();
        voiceSelect.innerHTML = '';
        voices.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v.name;
          opt.textContent = `${v.name} (${v.lang})${v.default ? ' — default' : ''}`;
          voiceSelect.appendChild(opt);
        });
        const zh = voices.find(v => /^zh(-|_)?/i.test(v.lang));
        if (zh) voiceSelect.value = zh.name;
      }
      speechSynthesis.onvoiceschanged = populateVoices;
      populateVoices();
      refreshVoicesBtn.addEventListener('click', populateVoices);

      function showOptionsView() {
        isStudying = false; paused = false;
        options.style.display = ''; studyControls.style.display = 'none'; nowPlaying.style.display = 'none';
      }
      function showStudyView() {
        options.style.display = 'none'; studyControls.style.display = ''; nowPlaying.style.display = '';
      }
      function currentVoice() {
        return voices.find(v => v.name === voiceSelect.value) || null;
      }
      function speakText(text, onend) {
        const u = new SpeechSynthesisUtterance(text);
        const v = currentVoice(); if (v) u.voice = v;
        u.rate = parseFloat(rateEl.value || '1');
        u.onend = onend; u.onerror = onend;
        synth.speak(u);
      }

      function truncate(s, n) { return s && s.length > n ? s.slice(0, n) + '…' : s; }
      function buildStartPoints() {
        const size = parseInt(setSizeEl.value, 10);
        startPointEl.innerHTML = '';
        for (let i = 0; i < SENTENCES.length; i += size) {
          const opt = document.createElement('option');
          opt.value = String(i);
          opt.textContent = `${i + 1}: ${truncate(SENTENCES[i]?.chinese || '', 18)}`;
          startPointEl.appendChild(opt);
        }
      }
      setSizeEl.addEventListener('change', buildStartPoints);
      buildStartPoints();

      let isStudying = false, paused = false;

      function makeOrderSlice(startIdx) {
        const seq = Array.from({ length: SENTENCES.length - startIdx }, (_, k) => startIdx + k);
        if (randomizeEl.checked) {
          for (let i = seq.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [seq[i], seq[j]] = [seq[j], seq[i]];
          }
        }
        return seq;
      }

      function speakSentenceBoth(row, reps, cb) {
        let remaining = reps;
        const cycle = () => {
          if (remaining <= 0) { cb && cb(); return; }
          // Chinese then English
          speakText(row.chinese || '', () => {
            speakText(row.english || '', () => {
              remaining--; if (!isStudying || paused) { cb && cb(); return; }
              if (remaining > 0) cycle(); else cb && cb();
            });
          });
        };
        cycle();
      }

      function studySet(order, cursor, size, reps, done) {
        const end = Math.min(cursor + size, order.length);
        let i = cursor;
        const next = () => {
          if (!isStudying) return;
          if (i >= end) { done && done(end); return; }
          const row = SENTENCES[order[i]];
          nowChinese.textContent = row.chinese || '';
          nowEnglish.textContent = row.english || '';
          progress.textContent = `Sentence ${order[i] + 1} / ${SENTENCES.length}`;
          speakSentenceBoth(row, reps, () => { if (!isStudying) return; i++; if (!paused) next(); });
        };
        next();
      }

      function startStudy() {
        const startIdx = parseInt(startPointEl.value, 10) || 0;
        const size = parseInt(setSizeEl.value, 10) || 5;
        const reps = parseInt(repetitionsEl.value, 10) || 3;
        let order = makeOrderSlice(startIdx);
        showStudyView(); isStudying = true; paused = false;
        const doSet = (cursor) => {
          if (cursor >= order.length) { showOptionsView(); return; }
          studySet(order, cursor, size, reps, (newCursor) => {
            if (autoAdvanceEl.checked) doSet(newCursor);
            else showOptionsView();
          });
        };
        doSet(0);
      }

      rateEl.addEventListener('input', () => { rateValue.textContent = Number(rateEl.value).toFixed(2); });
      rateValue.textContent = Number(rateEl.value).toFixed(2);

      studyBtn.addEventListener('click', startStudy);
      backBtn.addEventListener('click', () => window.location.href = 'index.html');
      pauseBtn.addEventListener('click', () => {
        if (!isStudying) return;
        if (!paused) { synth.pause(); paused = true; pauseBtn.textContent = 'Resume'; }
        else { synth.resume(); paused = false; pauseBtn.textContent = 'Pause'; }
      });
      stopBtn.addEventListener('click', () => { synth.cancel(); showOptionsView(); });

      showOptionsView();
    })();
  </script>
</body>
</html>
